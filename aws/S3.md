AWS S3


## MFA-Delete

AWS S3 有個保護 Object 的機制, 啟用後, 則無法在 AWS Console 刪除 Object

是否需要驗證 MFA 才能刪除? 這還沒有確認...

啟用/關閉 MFA-delete (必須要是 root account 才能做)

- [Configuring MFA delete](https://docs.aws.amazon.com/AmazonS3/latest/userguide/MultiFactorAuthenticationDelete.html)


```bash
#ENABLED=enabled
#ENABLED=disabled
aws s3api put-bucket-versioning \
    --bucket $BUCKET_NAME \
    --versioning-configuration Status=$ENABLED,MFADelete=Enabled \
    --profile $CONFIG_NAME \
    --mfa "$MFA_DEVICE_ARN $MFA_CODE"
# CONFIG_NAME 預設為 default
```


## Bucket Policy - Encryption

- S3 Bucket 可設定 *Default Encryption*, Server-Side Encryption:
    - Disable
    - Enable (可設定 customer-provided encryption key(SSE-C))
        - Amazon S3 Key(SSE-S3)
            - 如果用這個, 將來 user 上傳 file 
                - 若有 encrypt, 則照 user 使用的方式 store, 
                - 若沒 encrypt, 則依照此設定 encrypt & store
        - AWS Key Management Service key(SSE-KMS)
            - 


## Access Logs

- Bucket 可 Enable *Server access logging*, 需要指定一個目標 Bucket 作爲儲存 log 的位置.
    - 則將來任何 access Bucket 的操作, 都會有操作的 logging 被保存下來
    - [Server Access Log Format](https://docs.aws.amazon.com/AmazonS3/latest/userguide/LogFormat.html)


## Bucket Replication (CRR & SRR)

- Cross Region Replication
- Same Region Replication
- 若要啟用的話, 需要在 Source && Destionation Bucket 皆啟用 Versioning
- 可額外 Enable *Delete Marker Replication*, 則可對 Source 刪除的物件, Replicate 它的 Delete Marker 到 Destionation Bucket
    - 如果沒這麼做的話, Destionation 依舊會存在著 Source 早已刪除掉的 Object


## S3 Pre-Signed URLs

- 可用來產生 供 Download/Access 的 URL(by CLI / AWS Console)
    - 預設為 3600s
    - 可用 `--expires-in [TIME_BY_SECONDS]` 變更 timeout
- 用來產生 供 Upload 的 URL(by SDK)
- Use case
    - 特定期間有效的 URL (ex: 1 hr 後到期)


## Storage Class

- 分為下列各種儲存類別. 僅 Standard 存取資料為 Free, 其餘會 Charge
    - Standard-General Purpose
    - Standard-Infrequent Access, IA
    - One Zone-Infrequent Access
    - Glacier Instant Retrieval
        - 最少需要保存 90 days
        - 存取速度同 Standard
    - Glacier Flexible Retrieval (一般稱 S3 Glacier)
        - 最少須保存 90 days
        - 有三種 flexibility
            - Expedited (取資料 1~5 mins)
            - Standard  (取資料 3~5 hrs)
            - Bulk      (取資料 5~12 hrs)
    - Glacier Deep Archive
        - 最少須保存 180 days
        - 有兩種 flexibility
            - Standard  (取資料 12 hrs)
            - Bulk      (取資料 48 hrs)
    - Intelligent Tiering
        - AWS 會自動協助變更 S3 Class
            - 會產生 monthly monitoring && auto-tiering fee


## S3 Life Cycle Rules

- 可藉由此配置, 來設定一系列規則, 讓 AWS 依照這些規則來協助調整 Storage Class
    - Transition actions - 不同 Storage Class 之間的轉換規則
    - Expiration actions - 過一段時間以後, Delete Object. 也可用來刪除 Old Versioning
- 而上述的這些, 可設定 Rules, ex: `s3://mybucket/mp3/*`. 看要套用 Bucket 內的哪些 Objects
- Use Case:
    - 用戶上傳圖片, 程序會製作縮圖, 分別將 src img 及 thumbnail 做儲存(需 45 天內可隨時取得)
        - 將 src img 存入 Standard General Purpose, 搭配 life cycle, 45 天後, 移至 Glacier
        - 將 thumbnail 存入 One-Zone IA(可隨時取得 && 若壞了可隨時由 src img 還原), life cycle 則 45 天後移除
    - 對於 15 天內已移除的資料, 能被隨時還原(即使很少發生), 此外 365 天內移除的資料, 也可在 48 hrs 還原 
        - 需啟用 S3 Versioning, 來確保資料移除後可被還原
        - 因而移除後的 Versioning, 會被 Delete Marker 給遮蔽 (也可輕易地被還原)
        - 而 non-current Versions, 則可放入 Standard IA(省成本 && 需求有提到較少發生)
        - 再搭配 life cycle, 15 天後將 non-current versions 移入 Deep Archive
- 除了自行配置 Life Cycle Rules 以外, 也可使用 **S3 Analytics**, 來讓 AWS 幫忙決定 Storage Class 該如何自動配置
    - 透過機器學習
    - 不適用 *One-Zone IA* && *Glacier*, 僅適用 *Standard* && *Standard IA*
    - 起碼需讓他運行個 24 - 48 hrs, 才能開始運作


## S3 - Performance && KMS Limitation

- 預設來說, S3 Object && S3 Object Prefix, 都有很高的吞吐量
    - GET/HEAD, 5500/sec
    - PUT/COPY/POST/DELETE, 3500/sec
- 如果有啟用 KMS, 則可能會遇到 KMS limits 的限制, 導致 S3 吞吐量下滑
    - 無論是 Upload/Download Object <-> S3, 使用到 KMS Key, 都會呼叫到與此對應的 API 來作加解密
    - 此 API 會有訪問限額(不同 Region 不相同), 但可藉由 **Service Quotas Console** 調整此限額

